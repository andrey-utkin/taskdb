#!/usr/bin/env python3

import os
import subprocess
from pprint import pprint
import psycopg2
import psycopg2.extras

calendar = 'fb9ed04e-572b-477f-bdad-d6dbb32c0d82'
calendar_prefix = 'fastmail_calendar/'

child = subprocess.Popen(['/bin/rm', '-rf', '/home/j/.calendars/' + calendar])
child.wait()
child = subprocess.Popen(['/bin/mkdir', '/home/j/.calendars/' + calendar])
child.wait()
child = subprocess.Popen(['/usr/bin/vdirsyncer', 'sync', '--force-delete', calendar_prefix + calendar])
child.wait()

conn = psycopg2.connect("dbname=j user=j")
cur = conn.cursor(cursor_factory=psycopg2.extras.DictCursor)

cur.execute("SELECT uuid, scheduled, description FROM tasks WHERE ((tasks.status = 'pending'::public.task_status) AND ((tasks.scheduled < (CURRENT_DATE + '7 days'::interval))));")

while True:
    row = cur.fetchone()
    if not row:
        break
    pprint(row)
    env = os.environ.copy()
    env['KHAL_UID'] = row['uuid']
    child = subprocess.Popen(['/usr/bin/python3', '/usr/bin/khal', 'new', '--calendar', calendar, row['scheduled'].strftime('%Y-%m-%d %H:%M'), row['description']], env=env)
    child.wait()

cur.close()
conn.close()

child = subprocess.Popen(['/usr/bin/vdirsyncer', 'sync', calendar_prefix + calendar])
child.wait()
